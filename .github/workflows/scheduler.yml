name: Fan-out scheduler (main)

on:
  schedule:
    - cron: "*/30 * * * *"   # every 30 minutes, UTC
  workflow_dispatch: {}

permissions:
  contents: read
  actions: write

jobs:
  dispatch:
    runs-on: ubuntu-latest
    env:
      BRANCHES: '["dev","main"]'
      WORKFLOW_FILE: "branch-workflow.yml"
      GH_TOKEN: ${{ github.token }}  # gh will use this
    steps:
      - name: Fan out to branches via GitHub CLI
        run: |
          for b in $(echo "$BRANCHES" | jq -r '.[]'); do
            echo "Dispatching $WORKFLOW_FILE on branch: $b"
            gh workflow run "$WORKFLOW_FILE" \
              --ref "$b" \
              --repo "$GITHUB_REPOSITORY" \
              --json url | jq -r '.url'
          done
